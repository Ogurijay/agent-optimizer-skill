# HEARTBEAT.md - 心跳任务

## 任务：子代理任务状态监控

每 10 分钟执行一次，检查所有子代理的运行状态并汇报。

### 执行步骤：

1. **获取所有会话列表**
   - 使用 `sessions_list` 获取当前所有会话
   - 限制数量为 50（足够覆盖所有子代理）

2. **过滤子代理会话**
   - 排除主会话（agent:main:main）
   - 关注 `kind` 字段或通过 `label` 识别子代理任务

3. **汇总状态信息**
   - 运行中的任务数量
   - 每个任务的类型（通过 label 或 transcript 识别）
   - **运行时间**：`服务器当前时间 - 任务启动时间`
     - 从会话创建时间获取任务启动时间
     - 或从 transcript 中解析第一个任务消息的时间戳
   - 最近的消息内容（获取状态）

4. **发送汇报**
   - 使用 `message` 工具发送到 Telegram
   - 格式：
     ```
     🔄 任务状态汇报
     - 运行中：X 个任务
       - [任务1] 类型：xxx，时长：X分X秒，状态：运行中
       - [任务2] 类型：xxx，时长：X分X秒，状态：xxx
     - 近期完成：Y 个任务
       - [任务1] 类型：xxx，耗时：X分X秒，结果：成功
       - [任务2] 类型：xxx，耗时：X分X秒，结果：失败
     ```

### 注意事项

- 如果没有运行中的任务，可以不发送汇报或发送简短提示
- 重点关注长时间运行的任务（超过 30 分钟）
- 如果有失败的任务，需要说明失败原因
